# Capability: Podcast Feed

## Purpose

RSS 2.0 podcast feed generation and HTTP serving of feed XML and MP3 audio files, plus scheduled episode cleanup.

## Requirements

### Requirement: RSS 2.0 podcast feed generation
The system SHALL generate a valid RSS 2.0 XML file using ROME's `SyndFeed` API. The feed SHALL include standard podcast metadata (title, description, link) from application configuration, and each episode SHALL be represented as an `<item>` with an `<enclosure>` tag pointing to the MP3 file URL. The feed SHALL be regenerated each time a new episode is produced.

#### Scenario: Feed generated with episodes
- **WHEN** 3 episodes exist in the database
- **THEN** the RSS feed contains 3 `<item>` entries, each with a valid `<enclosure>` tag containing the MP3 URL, file size in bytes, and MIME type `audio/mpeg`

#### Scenario: Feed generated with no episodes
- **WHEN** no episodes exist in the database
- **THEN** the RSS feed is valid XML with channel metadata but no `<item>` entries

#### Scenario: Feed updated after new episode
- **WHEN** a new episode is generated by the TTS pipeline
- **THEN** the RSS feed XML is regenerated to include the new episode

### Requirement: MP3 file serving
The system SHALL serve MP3 files over HTTP from the configured episodes directory using Spring Boot's static resource handling. Files SHALL be accessible at a URL path that matches the `<enclosure>` URLs in the RSS feed.

#### Scenario: MP3 file accessible via HTTP
- **WHEN** a podcast app requests an MP3 URL from the feed
- **THEN** the MP3 file is served with content type `audio/mpeg`

#### Scenario: Missing MP3 returns 404
- **WHEN** a request is made for a non-existent MP3 file
- **THEN** the server returns HTTP 404

### Requirement: RSS feed serving
The system SHALL serve the podcast RSS feed XML over HTTP at a well-known endpoint (e.g., `/feed.xml`). Podcast apps subscribe to this URL.

#### Scenario: Feed accessible via HTTP
- **WHEN** a podcast app requests `/feed.xml`
- **THEN** the RSS XML is served with content type `application/rss+xml`

### Requirement: Episode cleanup
The system SHALL run a scheduled cleanup job that deletes episodes older than the configured retention period (default: 30 days). Cleanup SHALL remove both the database record and the MP3 file from disk. The podcast feed SHALL be regenerated after cleanup.

#### Scenario: Old episodes cleaned up
- **WHEN** the cleanup job runs and 2 episodes are older than 30 days
- **THEN** both episode records are deleted from the database, their MP3 files are deleted from disk, and the RSS feed is regenerated

#### Scenario: Recent episodes preserved
- **WHEN** the cleanup job runs and all episodes are less than 30 days old
- **THEN** no episodes are deleted

#### Scenario: Cleanup with missing MP3 file
- **WHEN** an episode record references an MP3 file that no longer exists on disk
- **THEN** the episode database record is still deleted and a warning is logged

### Requirement: Podcast-scoped RSS feed
The system SHALL serve an RSS 2.0 feed per podcast at `/users/{userId}/podcasts/{podcastId}/feed.xml`. The feed SHALL contain only episodes belonging to that podcast.

#### Scenario: Get feed for podcast with episodes
- **WHEN** a `GET /users/{userId}/podcasts/{podcastId}/feed.xml` request is received for a podcast with 5 episodes
- **THEN** the system returns HTTP 200 with Content-Type `application/rss+xml` containing an RSS 2.0 feed with 5 entries, sorted by most recent first

#### Scenario: Get feed for podcast with no episodes
- **WHEN** a `GET /users/{userId}/podcasts/{podcastId}/feed.xml` request is received for a podcast with no episodes
- **THEN** the system returns HTTP 200 with a valid RSS 2.0 feed containing zero entries

#### Scenario: Get feed for non-existing podcast
- **WHEN** a `GET /users/{userId}/podcasts/{podcastId}/feed.xml` request is received for a podcast that does not exist
- **THEN** the system returns HTTP 404

### Requirement: Feed metadata includes podcast and user name
The RSS feed title SHALL incorporate the podcast name and user name to distinguish feeds in podcast apps (e.g., "{configured feed title} - {userName} - {podcastName}").

#### Scenario: Feed title with user and podcast name
- **WHEN** the RSS feed is generated for user "Jeroen" and podcast "AI News"
- **THEN** the feed title is "{configured feed title} - Jeroen - AI News"

### Requirement: Episode audio served from podcast-scoped paths
Episode audio files SHALL be accessible via `/episodes/{podcastId}/{filename}` and the RSS feed `<enclosure>` URLs SHALL reference this path.

#### Scenario: Audio file URL in feed
- **WHEN** the feed is generated for a podcast with an episode whose audio file is at `data/episodes/{podcastId}/briefing-20260101-060000.mp3`
- **THEN** the enclosure URL in the feed entry is `{baseUrl}/episodes/{podcastId}/briefing-20260101-060000.mp3`

#### Scenario: Serve audio file
- **WHEN** a `GET /episodes/{podcastId}/{filename}` request is received for an existing audio file
- **THEN** the system returns the MP3 file with Content-Type `audio/mpeg`

### Requirement: Episode cleanup scoped to podcast
Episode cleanup (retention policy) SHALL operate per-podcast, deleting expired episodes and their audio files from the podcast-scoped directory.

#### Scenario: Clean up old episodes
- **WHEN** the cleanup job runs and a podcast has episodes older than the retention period
- **THEN** those episodes are deleted from the database and their audio files are removed from the podcast's episode directory

### Requirement: Remove global feed endpoint
The global `/feed.xml` endpoint SHALL be removed. The global `/generate` endpoint SHALL be removed. These are replaced by podcast-scoped equivalents.

#### Scenario: Access old global feed
- **WHEN** a `GET /feed.xml` request is received
- **THEN** the system returns HTTP 404 (or does not match any route)

#### Scenario: Access old global generate
- **WHEN** a `POST /generate` request is received
- **THEN** the system returns HTTP 404 (or does not match any route)
